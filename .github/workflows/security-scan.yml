name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Allow manual triggering
  workflow_dispatch:

jobs:
  gitleaks:
    name: Detect Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect secrets in code
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          config-path: .gitleaks.toml
          # Don't fail the workflow during initial implementation
          # Later, change to true once existing issues are resolved
          fail-on-findings: false

  env-file-check:
    name: Check for Committed Environment Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Check for committed .env files
        run: |
          ENV_FILES=$(find . -type f -name ".env*" -not -name ".env.example" -not -path "*/node_modules/*")
          if [[ -n "$ENV_FILES" ]]; then
            echo "::warning::Found environment files that should not be committed:"
            echo "$ENV_FILES"
            echo "These files may contain sensitive information and should be removed from the repository."
            # Don't fail the workflow during initial implementation
            # Later, uncomment the line below once existing issues are resolved
            # exit 1
          else
            echo "No problematic environment files found."
          fi 