version: 1
backend:
    phases:
        build:
            commands:
                - 'echo "Building backend..."'
frontend:
    phases:
        preBuild:
            commands:
                - 'echo "Node version $(node -v)"'
                - 'echo "NPM version $(npm -v)"'
                - 'rm -f package-lock.json || true'
                - 'npm install --force --legacy-peer-deps'
        build:
            commands:
                - 'echo "Building application..."'
                # Configure Auth0 based on deployment branch
                - 'if [ "$AWS_BRANCH" = "main" ]; then
                      export AUTH0_BASE_URL=https://plan.goprsu.com;
                      export AUTH0_CALLBACK_URL=https://plan.goprsu.com/api/auth/callback;
                      export AUTH0_POST_LOGOUT_REDIRECT_URI=https://plan.goprsu.com;
                   else
                      export AUTH0_BASE_URL=https://main.d37729cvqwp6nc.amplifyapp.com;
                      export AUTH0_CALLBACK_URL=https://main.d37729cvqwp6nc.amplifyapp.com/api/auth/callback;
                      export AUTH0_POST_LOGOUT_REDIRECT_URI=https://main.d37729cvqwp6nc.amplifyapp.com;
                   fi'
                - 'export AUTH0_SECRET=035C08832FF8B4F6822A2011DBF59AEF'
                - 'export AUTH0_ISSUER_BASE_URL=https://dev-rd6ngmdjrin41op1.us.auth0.com'
                - 'export AUTH0_CLIENT_ID=bKTISFkk7y8t6U8hUEwcPR79aqTRDE4B'
                - 'export AUTH0_CLIENT_SECRET=uWrDx8ww-SxviAaAQIAw1l8KV2HoWa1pJ0DlbzbTR_H-AN-Bewg1dVHAdsCcKT5n'
                - 'export AUTH0_SCOPE="openid profile email"'
                - 'export AUTH0_AUDIENCE=""'
                - 'export OPENROUTER_API_KEY=sk-or-v1-6753c17c4ad06fc833395fd3b1031c2012dc9b112f1a4338f092b9d6e2e6847cd'
                - 'export DATABASE_URL=postgresql://neondb_owner:npg_MsBRLcZy14fT@ep-bitter-smoke-a56n6lnq-pooler.us-east-2.aws.neon.tech/neondb?sslmode=require'
                - 'export POSTGRES_URL=postgresql://neondb_owner:npg_MsBRLcZy14fT@ep-bitter-smoke-a56n6lnq-pooler.us-east-2.aws.neon.tech/neondb?sslmode=require'
                - 'npm run build'
                - 'echo "Preparing output for deployment..."'
                - 'cp -r .next/ out/'
                - 'cp next.config.ts out/'
                - 'cp package.json out/'
                - 'mkdir -p out/public'
                - 'cp -r public/* out/public/ || true'
    artifacts:
        baseDirectory: out
        files:
            - '**/*'
    cache:
        paths:
            - 'node_modules/**/*'
            - '.next/cache/**/*'
    customHeaders:
        - pattern: '**/*'
          headers:
            - key: 'Cache-Control'
              value: 'public, max-age=0, must-revalidate'
    environment:
        variables:
            AUTH0_SECRET: '035C08832FF8B4F6822A2011DBF59AEF'
            AUTH0_BASE_URL: 'https://plan.goprsu.com'
            AUTH0_CALLBACK_URL: 'https://plan.goprsu.com/api/auth/callback'
            AUTH0_POST_LOGOUT_REDIRECT_URI: 'https://plan.goprsu.com'
            AUTH0_ISSUER_BASE_URL: 'https://dev-rd6ngmdjrin41op1.us.auth0.com'
            AUTH0_CLIENT_ID: 'bKTISFkk7y8t6U8hUEwcPR79aqTRDE4B'
            AUTH0_CLIENT_SECRET: 'uWrDx8ww-SxviAaAQIAw1l8KV2HoWa1pJ0DlbzbTR_H-AN-Bewg1dVHAdsCcKT5n'
            AUTH0_SCOPE: 'openid profile email'
            AUTH0_AUDIENCE: ''
            OPENROUTER_API_KEY: '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'
            DATABASE_URL: 'postgresql://neondb_owner:npg_MsBRLcZy14fT@ep-bitter-smoke-a56n6lnq-pooler.us-east-2.aws.neon.tech/neondb?sslmode=require'
            POSTGRES_URL: 'postgresql://neondb_owner:npg_MsBRLcZy14fT@ep-bitter-smoke-a56n6lnq-pooler.us-east-2.aws.neon.tech/neondb?sslmode=require' 