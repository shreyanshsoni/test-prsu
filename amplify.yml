version: 1
backend:
    phases:
        build:
            commands:
                - 'echo "Building backend..."'
frontend:
    phases:
        preBuild:
            commands:
                - 'echo "Node version $(node -v)"'
                - 'echo "NPM version $(npm -v)"'
                - 'rm -f package-lock.json || true'
                - 'npm install --force --legacy-peer-deps'
        build:
            commands:
                - 'echo "Building application..."'
                # Configure Auth0 based on deployment branch
                - 'if [ "$AWS_BRANCH" = "main" ]; then
                      export AUTH0_BASE_URL=https://plan.goprsu.com;
                      export AUTH0_CALLBACK_URL=https://plan.goprsu.com/api/auth/callback;
                      export AUTH0_POST_LOGOUT_REDIRECT_URI=https://plan.goprsu.com;
                   else
                      export AUTH0_BASE_URL=https://main.d37729cvqwp6nc.amplifyapp.com;
                      export AUTH0_CALLBACK_URL=https://main.d37729cvqwp6nc.amplifyapp.com/api/auth/callback;
                      export AUTH0_POST_LOGOUT_REDIRECT_URI=https://main.d37729cvqwp6nc.amplifyapp.com;
                   fi'
                # Use environment variables from Amplify environment configuration
                - 'echo "Using environment variables from Amplify configuration"'
                - 'npm run build'
                - 'echo "Preparing output for deployment..."'
                - 'cp -r .next/ out/'
                - 'cp next.config.ts out/'
                - 'cp package.json out/'
                - 'mkdir -p out/public'
                - 'cp -r public/* out/public/ || true'
    artifacts:
        baseDirectory: out
        files:
            - '**/*'
    cache:
        paths:
            - 'node_modules/**/*'
            - '.next/cache/**/*'
    customHeaders:
        - pattern: '**/*'
          headers:
            - key: 'Cache-Control'
              value: 'public, max-age=0, must-revalidate'
    # Environment variables should be configured in the Amplify Console
    # and not hardcoded in this file
    environment:
        variables:
            # These are placeholder references - actual values should be set in Amplify Console
            AUTH0_BASE_URL: 'https://plan.goprsu.com'
            AUTH0_CALLBACK_URL: 'https://plan.goprsu.com/api/auth/callback'
            AUTH0_POST_LOGOUT_REDIRECT_URI: 'https://plan.goprsu.com' 