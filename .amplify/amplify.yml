version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Setting up Node.js 20..."
        - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
        - export NVM_DIR="$HOME/.nvm"
        - [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        - nvm install 20
        - nvm use 20
        - echo "Node version $(node -v)"
        - echo "NPM version $(npm -v)"
        - echo "Clearing npm cache..."
        - npm cache clean --force
        - echo "Updating package-lock.json to match package.json..."
        - rm -f package-lock.json
        - echo "Installing dependencies with --legacy-peer-deps..."
        - npm install --legacy-peer-deps --verbose
        - echo "Environment variables are automatically loaded by Amplify"
        - echo "Verifying critical environment variables..."
        - |
          node -e "
            const required = ['AUTH0_SECRET', 'AUTH0_CLIENT_ID', 'POSTGRES_URL'];
            const missing = required.filter(v => !process.env[v]);
            if (missing.length > 0) {
              console.error('Missing required environment variables:', missing);
              process.exit(1);
            }
            console.log('All required environment variables are available');
          "
    build:
      commands:
        - echo "Starting SSR build process..."
        - npm run build
        - echo "SSR build completed successfully"
        - echo "Verifying build output..."
        - ls -la .next/
        - echo "Checking for required-server-files.json..."
        - test -f .next/required-server-files.json && echo "✅ required-server-files.json found" || echo "❌ required-server-files.json missing"
        - echo "Copying .next to output directory..."
        - cp -r .next/* out/
        - echo "Verifying output directory..."
        - ls -la out/
        - test -f out/required-server-files.json && echo "✅ required-server-files.json in output" || echo "❌ required-server-files.json missing from output"
      env:
        NODE_ENV: production
  artifacts:
    baseDirectory: out
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  rewrites:
    - source: '/(.*)'
      target: '/index.html'
      status: '200'
