version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Node version $(node -v)"
        - echo "NPM version $(npm -v)"
        - echo "Clearing npm cache..."
        - npm cache clean --force
        - echo "Updating package-lock.json to match package.json..."
        - rm -f package-lock.json
        - echo "Installing dependencies with --legacy-peer-deps..."
        - npm install --legacy-peer-deps --verbose
        - echo "Current working directory: $(pwd)"
        - echo "Environment variables are automatically loaded by Amplify"
        - echo "Verifying critical environment variables..."
        - |
          # Test that required environment variables are available
          node -e "
            const required = ['AUTH0_SECRET', 'AUTH0_CLIENT_ID', 'POSTGRES_URL'];
            const missing = required.filter(v => !process.env[v]);
            if (missing.length > 0) {
              console.error('Missing required environment variables:', missing);
              process.exit(1);
            }
            console.log('All required environment variables are available');
          "
    build:
      commands:
        - echo "Starting SSR build process..."
        - npm run build
        - echo "SSR build completed successfully"
      env:
        NODE_ENV: production
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=0, must-revalidate'
  rewrites:
    - source: '/(.*)'
      target: '/index.html'
      status: '200'
