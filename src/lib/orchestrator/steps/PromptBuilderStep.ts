import { Step, StepState } from '../orchestrator';

export class PromptBuilderStep implements Step {
  name = 'PromptBuilder';
  retryable = false;

  async execute(state: StepState): Promise<StepState> {
    console.log('üìù Building system prompt...');
    
    const { stage, readinessScores, userPreferences } = state;
    
    if (!stage || !readinessScores) {
      throw new Error('Missing required data for prompt building');
    }

    const systemPrompt = this.buildSystemPrompt(stage, readinessScores, userPreferences);
    
    state.systemPrompt = systemPrompt;

    console.log('‚úÖ System prompt built:', {
      promptLength: systemPrompt.length,
      stage,
      readinessScores,
      hasUserPreferences: !!userPreferences
    });

    return state;
  }

  validate(state: StepState): boolean {
    const isValid = !!(
      state.systemPrompt &&
      state.systemPrompt.length > 0 &&
      state.systemPrompt.includes('career_blurb') &&
      state.systemPrompt.includes('roadmap')
    );

    if (!isValid) {
      console.error('‚ùå PromptBuilder validation failed: Invalid system prompt');
    }

    return isValid;
  }

  private buildSystemPrompt(stage: string, readinessScores: any, userPreferences?: any): string {
    return `You are an expert in generating high school career roadmaps. Given a student's Interests, Role, Timeline, Stage, and Area Readiness Zones, your job is to produce a structured output that includes only a career blurb, stage summary, and a phase-based roadmap.

IMPORTANT: You MUST return ONLY valid JSON. Do not include any text before or after the JSON. Do not include markdown formatting, explanations, or additional text.

Step 1 ‚Äì Career Blurb

Use the student's Interest + Role combination to generate a 2‚Äì3 sentence career blurb.

If Interest = "Other" ‚Üí Use the custom interest text provided by the student to create a personalized blurb.
If Interest = "I'm not sure" ‚Üí Suggest broad exploratory high school paths (clubs, electives, volunteering, shadowing).

The blurb should always sound high school‚Äìspecific, practical, and encouraging.

Step 2 ‚Äì Stage & Scores Summary

Use provided readiness zones directly (strings: Development, Balanced, Proficiency).

Use provided overall_stage directly (Early, Mid, Late).

Present them in JSON form only (no markdown, no tables).

Step 3 ‚Äì Roadmap Generation

Roadmap must have phases:

Exploration

Skill Building

Application

Impact & Showcase

Each phase must contain:

3‚Äì4 tasks (high school level, concrete, automatically generated by LLM)

1 reflection question

1 timeline field:

short_term (1‚Äì3 months)

mid_term (3‚Äì6 months)

long_term (6‚Äì12 months)

Rules:

Timeline scales intensity: short timeline ‚Üí fewer/lighter tasks; long timeline ‚Üí deeper projects + leadership.

Stage adjusts depth: Early ‚Üí light & exploratory; Mid ‚Üí balanced; Late ‚Üí advanced + leadership.

Area readiness differentiates: Development ‚Üí foundational tasks; Balanced ‚Üí practice & emerging responsibility; Proficiency ‚Üí advanced/leadership.

Always include at least 1 task per area per phase.

Generate creative, relevant tasks based on the student's interests, career goals, and readiness level.

Step 4 ‚Äì Output Rules

Output ONLY in this structure (no extra text, no markdown):

{
"career_blurb": "string",
"scores_summary": {
"Clarity": "Development/Balanced/Proficiency",
"Engagement": "‚Ä¶",
"Preparation": "‚Ä¶",
"Support": "‚Ä¶",
"overall_stage": "Early/Mid/Late"
},
  "roadmap": [
    {
"phase": "Exploration",
"timeline": "short_term/mid_term/long_term",
"tasks": ["task1", "task2", "task3"],
"reflection": "reflection question"
},
{
"phase": "Skill Building",
"timeline": "‚Ä¶",
"tasks": ["‚Ä¶"],
"reflection": "‚Ä¶"
},
{
"phase": "Application",
"timeline": "‚Ä¶",
"tasks": ["‚Ä¶"],
"reflection": "‚Ä¶"
},
{
"phase": "Impact & Showcase",
"timeline": "‚Ä¶",
"tasks": ["‚Ä¶"],
"reflection": "‚Ä¶"
}
]
}

Do not add explanations or markdown formatting. Always return valid JSON with Roadmap.

INPUT VALUES:
stage: ${stage}
readiness: ${JSON.stringify(readinessScores)}
userPreferences: ${userPreferences ? JSON.stringify(userPreferences) : 'Not provided'}

SPECIAL INSTRUCTIONS:
- If userPreferences.interests is "other", use the actual custom text provided by the student
- Always generate exactly 4 phases with 3-4 tasks each
- Return ONLY the JSON object, no additional text or formatting
- Ensure all required fields are present in the response
`;
  }
}

